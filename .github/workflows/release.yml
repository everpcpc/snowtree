name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Which semver part to bump'
        type: choice
        required: true
        default: patch
        options:
          - patch
          - minor
          - major
      base_tag:
        description: 'Optional base tag (e.g. v1.2.3). Defaults to latest vX.Y.Z tag'
        type: string
        required: false

permissions:
  contents: write

jobs:
  create_release:
    name: Bump version, tag and create prerelease (draft)
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.next.outputs.tag }}
      version: ${{ steps.next.outputs.version }}
      sha: ${{ steps.create.outputs.sha }}
      previous: ${{ steps.next.outputs.previous }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure git
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Determine next version
        id: next
        shell: bash
        run: |
          set -euo pipefail
          BASE_TAG="${{ inputs.base_tag }}"
          if [ -z "${BASE_TAG}" ]; then
            BASE_TAG="$(git tag --sort=-version:refname | grep -E '^v[0-9]+\\.[0-9]+\\.[0-9]+$' | head -n 1 || true)"
          fi
          if [ -z "${BASE_TAG}" ]; then
            echo "No base tag found (no releases/latest and no vX.Y.Z tags)" >&2
            exit 1
          fi

          if ! [[ "${BASE_TAG}" =~ ^v([0-9]+)\\.([0-9]+)\\.([0-9]+)$ ]]; then
            echo "Base tag is not a stable semver tag: ${BASE_TAG}" >&2
            exit 1
          fi

          MAJOR="${BASH_REMATCH[1]}"
          MINOR="${BASH_REMATCH[2]}"
          PATCH="${BASH_REMATCH[3]}"

          case "${{ inputs.bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
            *)
              echo "Unknown bump: ${{ inputs.bump }}" >&2
              exit 1
              ;;
          esac

          NEXT_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          if gh api "repos/${GITHUB_REPOSITORY}/git/ref/tags/${NEXT_TAG}" >/dev/null 2>&1; then
            echo "Tag already exists on remote: ${NEXT_TAG}" >&2
            exit 1
          fi

          echo "previous=${BASE_TAG}" >> "${GITHUB_OUTPUT}"
          echo "tag=${NEXT_TAG}" >> "${GITHUB_OUTPUT}"
          echo "version=${NEXT_VERSION}" >> "${GITHUB_OUTPUT}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump package.json version
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.next.outputs.version }}"
          node -e 'const fs=require("fs"); const p=JSON.parse(fs.readFileSync("package.json","utf8")); p.version=process.env.VERSION; fs.writeFileSync("package.json", JSON.stringify(p,null,2)+"\\n");'
        env:
          VERSION: ${{ steps.next.outputs.version }}

      - name: Commit and tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.next.outputs.version }}"
          TAG="${{ steps.next.outputs.tag }}"

          git add package.json
          git commit -m "Bump version to ${VERSION}"
          git tag -a "${TAG}" -m "${TAG}"

      - name: Push (commit + tag)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.next.outputs.tag }}"
          git push origin HEAD:main
          git push origin "refs/tags/${TAG}"

      - name: Create prerelease (draft)
        id: create
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.next.outputs.tag }}"
          PREV="${{ steps.next.outputs.previous }}"
          SHA="$(git rev-parse HEAD)"

          echo "sha=${SHA}" >> "${GITHUB_OUTPUT}"
          {
            echo "Previous: ${PREV}"
            echo "Tag: ${TAG}"
            echo "SHA: ${SHA}"
          } >> "${GITHUB_STEP_SUMMARY}"

          gh release create "${TAG}" \
            --target "${SHA}" \
            --generate-notes \
            --notes-start-tag "${PREV}" \
            --prerelease \
            --draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: Build & upload assets (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: create_release
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/tags/${{ needs.create_release.outputs.tag }}

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.15.1'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm --filter @snowtree/core build && pnpm --filter @snowtree/desktop build && pnpm --filter @snowtree/ui build

      - name: Prepare release app directory (prod deps)
        shell: bash
        run: |
          set -euo pipefail
          RELEASE_APP_DIR="${RUNNER_TEMP}/release-app"
          echo "RELEASE_APP_DIR=${RELEASE_APP_DIR}" >> "${GITHUB_ENV}"

          rm -rf "${RELEASE_APP_DIR}"
          mkdir -p "${RELEASE_APP_DIR}/packages/desktop" "${RELEASE_APP_DIR}/packages/ui" "${RELEASE_APP_DIR}/packages/core"

          cp package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc LICENSE "${RELEASE_APP_DIR}/"
          cp -R packages/desktop/dist "${RELEASE_APP_DIR}/packages/desktop/dist"
          cp -R packages/desktop/assets "${RELEASE_APP_DIR}/packages/desktop/assets"
          cp packages/desktop/package.json "${RELEASE_APP_DIR}/packages/desktop/package.json"
          cp -R packages/ui/dist "${RELEASE_APP_DIR}/packages/ui/dist"

          cp "${GITHUB_WORKSPACE}/packages/core/package.json" "${RELEASE_APP_DIR}/packages/core/package.json"
          cp -R "${GITHUB_WORKSPACE}/packages/core/dist" "${RELEASE_APP_DIR}/packages/core/dist"
          cp -R "${GITHUB_WORKSPACE}/packages/core/dist-cjs" "${RELEASE_APP_DIR}/packages/core/dist-cjs"

          pushd "${RELEASE_APP_DIR}"
          pnpm install -P --frozen-lockfile --ignore-scripts
          popd

      - name: Rebuild native dependencies (Electron)
        shell: bash
        run: |
          set -euo pipefail
          pushd "${RELEASE_APP_DIR}"
          "${GITHUB_WORKSPACE}/node_modules/.bin/electron-builder" install-app-deps
          popd

      - name: Build artifacts (no publish)
        shell: bash
        run: |
          set -euo pipefail
          "${GITHUB_WORKSPACE}/node_modules/.bin/electron-builder" --projectDir "${RELEASE_APP_DIR}" --publish never

      - name: Verify packaged app contains core (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          ZIP="$(ls -1 "${RELEASE_APP_DIR}/dist-electron/"*macOS-arm64.zip | head -n 1)"
          TMP_DIR="${RUNNER_TEMP}/verify-app"
          rm -rf "${TMP_DIR}"
          mkdir -p "${TMP_DIR}"
          unzip -q "${ZIP}" -d "${TMP_DIR}"
          APP_ASAR="$(find "${TMP_DIR}" -path '*snowtree.app/Contents/Resources/app.asar' | head -n 1)"
          echo "Verifying asar: ${APP_ASAR}"
          "${GITHUB_WORKSPACE}/node_modules/.bin/asar" list "${APP_ASAR}" | grep -q "node_modules/@snowtree/core/dist-cjs/types/models.js"

      - name: Publish to GitHub Releases
        shell: bash
        run: |
          set -euo pipefail
          "${GITHUB_WORKSPACE}/node_modules/.bin/electron-builder" --projectDir "${RELEASE_APP_DIR}" --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure release assets uploaded (gh upload)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.create_release.outputs.tag }}"
          VER="${TAG#v}"
          DIST="${RELEASE_APP_DIR}/dist-electron"

          if [ ! -d "${DIST}" ]; then
            echo "Missing dist dir: ${DIST}" >&2
            exit 1
          fi

          mapfile -t FILES < <(
            find "${DIST}" -maxdepth 1 -type f \
              \( -name "latest-*.yml" -o -name "snowtree-${VER}-*" \) \
              -print
          )

          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No release assets found to upload in ${DIST}" >&2
            exit 1
          fi

          gh release upload "${TAG}" "${FILES[@]}" --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  finalize_release:
    name: Publish prerelease (undraft)
    runs-on: ubuntu-latest
    needs: [create_release, build]
    if: needs.build.result == 'success'
    steps:
      - name: Publish release (undraft, keep prerelease)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.create_release.outputs.tag }}"
          if [ -z "${TAG}" ]; then
            echo "Missing tag output" >&2
            exit 1
          fi

          echo "Publishing prerelease: ${TAG}"
          gh release edit "${TAG}" --draft=false --prerelease
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
