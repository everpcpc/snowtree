name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Release ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    permissions:
      contents: write

    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.15.1'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm --filter @snowtree/core build && pnpm --filter @snowtree/desktop build && pnpm --filter @snowtree/ui build

      - name: Prepare release app directory (prod deps)
        shell: bash
        run: |
          set -euo pipefail
          RELEASE_APP_DIR="${RUNNER_TEMP}/release-app"
          echo "RELEASE_APP_DIR=${RELEASE_APP_DIR}" >> "${GITHUB_ENV}"

          rm -rf "${RELEASE_APP_DIR}"
          mkdir -p "${RELEASE_APP_DIR}/packages/desktop" "${RELEASE_APP_DIR}/packages/ui"

          cp package.json pnpm-lock.yaml .npmrc LICENSE "${RELEASE_APP_DIR}/"
          cp -R packages/desktop/dist "${RELEASE_APP_DIR}/packages/desktop/dist"
          cp -R packages/desktop/assets "${RELEASE_APP_DIR}/packages/desktop/assets"
          cp -R packages/ui/dist "${RELEASE_APP_DIR}/packages/ui/dist"

          pushd "${RELEASE_APP_DIR}"
          pnpm install -P --frozen-lockfile --ignore-scripts

          mkdir -p node_modules/@snowtree/core
          cp "${GITHUB_WORKSPACE}/packages/core/package.json" node_modules/@snowtree/core/package.json
          cp -R "${GITHUB_WORKSPACE}/packages/core/dist" node_modules/@snowtree/core/dist
          cp -R "${GITHUB_WORKSPACE}/packages/core/dist-cjs" node_modules/@snowtree/core/dist-cjs
          popd

      - name: Rebuild native dependencies (Electron)
        shell: bash
        run: |
          set -euo pipefail
          pushd "${RELEASE_APP_DIR}"
          "${GITHUB_WORKSPACE}/node_modules/.bin/electron-builder" install-app-deps
          popd

      - name: Publish to GitHub Releases
        shell: bash
        run: |
          set -euo pipefail
          "${GITHUB_WORKSPACE}/node_modules/.bin/electron-builder" --projectDir "${RELEASE_APP_DIR}" --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
